<!DOCTYPE html>
<html>
<head>
<title>Vizit</title>
<style>
label {
  font-weight: bold;
}
.chart-title{
  font-weight: bold;
  text-decoration: underline;
}
.chart{
  width: 300px;
  height: 300px;
  float: left;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.8.0/plotly.min.js'></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
</head>
<body>
<div id="controls">
  <label for="file-input">Data sources:</label><br>
  <input type="file" id="file-input" name="files[]" multiple />
  <ul id="file-list">(no files selected)</ul>
  <div id="chart-controls"></div>
  <button id="add-chart">Add Chart</button>
</div>
<div id="outputs">
</div>
<script>
'use strict';
let files = {};
let fileNames = []; //sorted alphabetically
let config = {files:[], charts:[]};
const chartTypes = ['dot','line','line dot','stacked bar','grouped bar'];
// let trace1 = {
//   x: [1, 2, 3],
//   y: [4, 5, 6],
//   type: 'scatter',
// };

// let trace2 = {
//   x: [20, 30, 40],
//   y: [50, 60, 70],
//   // xaxis: 'x2',
//   // yaxis: 'y2',
//   type: 'scatter',
// };

// let data = [trace1];
// let data2 = [trace2];
// let layout = {
//   font: {
//     family: 'Courier New, monospace',
//     size: 14,
//     color: '#7f7f7f'
//   },
//   margin: {
//     l: 0,
//     r: 0,
//     b: 0,
//     t: 40,
//   },
//   title: {
//     text: 'what is it',
//     yref: "paper",
//     y : 1,
//     yanchor: "bottom",
//     pad: {
//       b: 5,
//     },
//   },
//   yaxis: {
//     title: {
//       text: 'y Axis',
//     },
//     automargin: true,
//   },
//   xaxis: {
//     title: {
//       text: 'y Axis',
//     },
//     automargin: true,
//   }
//   // grid: {rows: 1, columns: 2, pattern: 'independent'},
// };
// $('#outputs').append('<div id="myDiv" class="chart"></div>');
// Plotly.newPlot('myDiv', data, layout, {editable: true});
// $('#outputs').append('<div id="myDiv2" class="chart"></div>');
// Plotly.newPlot('myDiv2', data2, layout, {editable: true});

$('#file-input').change(function(evt){
  let newFiles = Array.from(evt.target.files);
  for(let i = 0; i < newFiles.length; i++){
    //If the file already exists, remove the old version
    if(newFiles[i].name in files){
      delete files[newFiles[i].name];
    }
    //Regardless, add the new file to the files object
    files[newFiles[i].name] = {}
    files[newFiles[i].name].fileObj = newFiles[i];
  }
  //Show files in html, sorted alphabetically
  $('#file-list').empty();
  fileNames = Object.keys(files).sort();
  for(let fileName of fileNames){
    $('#file-list').append(`<li>${fileName}</li>`);
  }
  config.files = fileNames;
});
$('#add-chart').click(function(){
  let idx = config.charts.length;
  config.charts.push({});
  let optionsHtml = `<option value="none">none</option>`;
  for(let fileName of fileNames){
    optionsHtml += `<option value="${fileName}">${fileName}</option>`;
  }
  let html = `
    <form id="chart-${idx}">
      <div class="chart-title">Chart ${idx}</div>
      <label>Data source:</label>
      <select class="data-source">${optionsHtml}</select>
    </form>
  `;
  $('#chart-controls').append(html);
});
$('#chart-controls').on('change','.data-source', function(){
  let selectFile = $(this).val();
  let chartIdx = parseInt(this.form.id.replace('chart-',''));
  if(!fileNames.includes(selectFile)){
    return;
  }
  //TODO: we shouldn't grab file data if we have done so already for another chart.
  Papa.parse(files[selectFile].fileObj, {
    header: false,
    complete: function(results, file) {
      //Get header and use to find column indices
      let header = results.data[0];
      files[selectFile].data = results.data;
      files[selectFile].header = header;
      let colidx = {};
      for (let i = 0; i < header.length; i++){
        colidx[header[i]] = i;
      }
      let arrayLength  = results.data.length;
      $(`#chart-${chartIdx}-controls`).remove()
      let optionsHtml = `<option value="none">none</option>`;
      for (let i = 0; i < header.length; i++){
        optionsHtml+= `<option value="${i}">${header[i]}</option>`;
      }
      //Add controls for x axis, y axis, color, style, row, column
      let html = `
        <div id="chart-${chartIdx}-controls" class="chart-ind-controls">
          <label>X axis:</label>
          <select class="chart-x">${optionsHtml}</select>
          <label>Y axis:</label>
          <select class="chart-y">${optionsHtml}</select>
          <label>Colors:</label>
          <select class="chart-c">${optionsHtml}</select>
      `;
      $('#chart-'+chartIdx).append(html);
    }
  });
});

$('#chart-controls').on('change','.chart-ind-controls select', function(){

});

</script>
</body>
</html>